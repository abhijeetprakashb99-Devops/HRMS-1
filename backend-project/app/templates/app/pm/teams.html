{% extends "app/base4.html" %}
{% load static %}
{% block content %}

<main class="content-wrap p-3" style="background:#f5fafa;">

    <!-- PAGE HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-3"
        style="background:#ffffff;border-left:5px solid #0b7368;padding:12px 18px;border-radius:6px;">
        <h4 class="fw-bold mb-0" style="color:#0b7368;">Teams Management</h4>
    </div>

    <!-- CARDS -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card text-center shadow-sm" style="border-top:4px solid #0b7368;">
                <div class="card-body">
                    <i class="fas fa-users fa-2x mb-2" style="color:#0b7368;"></i>
                    <h6 class="text-muted">Total Teams</h6>
                    <h3 style="color:#0b7368;">{{ total_teams }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center shadow-sm" style="border-top:4px solid #0b7368;">
                <div class="card-body">
                    <i class="fas fa-folder-open fa-2x mb-2" style="color:#0b7368;"></i>
                    <h6 class="text-muted">Total Projects</h6>
                    <h3 style="color:#0b7368;">{{ total_projects }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center shadow-sm" style="border-top:4px solid #0b7368;">
                <div class="card-body">
                    <i class="fas fa-user fa-2x mb-2" style="color:#0b7368;"></i>
                    <h6 class="text-muted">Total Employees</h6>
                    <h3 style="color:#0b7368;">{{ total_employees }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- TABLE HEADER + SEARCH -->
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div></div>
        <input type="text" id="filterTeams" class="form-control"
            style="max-width:280px;border:1px solid #0b7368;"
            placeholder="Search team lead / email">
    </div>

    <!-- TABLE -->
    <div class="table-responsive shadow-sm" style="background:#ffffff;border-radius:6px;">
        <table class="table table-bordered align-middle mb-0" id="teamsTable">
            <thead style="background:#0b7368;color:#ffffff;">
                <tr>
                    <th>#</th>
                    <th>Team Lead</th>
                    <th>Email</th>
                    <th>Projects</th>
                    <th>Members</th>
                    <th class="text-center">Action</th>
                </tr>
            </thead>
            <tbody id="teamsBody">
                {% for t in teams %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>
                   
                        <strong>{{ t.employee.first_name }} {{ t.employee.last_name }}</strong>
                    </td>
                    <td>{{ t.employee.email }}</td>
                    <td>
                        <span class="badge" style="background:#0b7368;">
                            {{ t.projectassignment_set.count }}
                        </span>
                    </td>
                    <td>
                        {% for p in t.projectassignment_set.all %}
                        <span class="badge bg-secondary">{{ p.team_members.count }}</span>
                        {% endfor %}
                    </td>
                    <td class="text-center">
                        <a href="{% url 'team-view' t.id %}" title="View">
                            <i class="fas fa-eye" style="color:#0b7368;"></i>
                        </a>
                        <a href="{% url 'team-edit' t.id %}" class="ms-2" title="Edit">
                            <i class="fas fa-edit" style="color:#f0ad4e;"></i>
                        </a>
                        <a href="{% url 'team-delete' t.id %}"
                            class="ms-2"
                            onclick="return confirm('Are you sure you want to delete this team record permanently?');"
                            title="Delete">
                            <i class="fas fa-trash" style="color:#d9534f;"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- PAGINATION -->
    <nav aria-label="Teams Pagination">
        <ul class="pagination justify-content-end mt-3" id="teamsPagination"></ul>
    </nav>

</main>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function(){

    // Table and search
    const tableBody = document.getElementById("teamsBody");
    const searchInput = document.getElementById("filterTeams");
    const pagination = document.getElementById("teamsPagination");
    const rowsPerPage = 5;
    let currentPage = 1;

    // Helper: get all rows
    function getAllRows() {
        return Array.from(tableBody.querySelectorAll("tr"));
    }

    // Filter rows based on search
    function getFilteredRows() {
        const query = searchInput.value.toLowerCase().trim();
        return getAllRows().filter(row => {
            return Array.from(row.querySelectorAll("td"))
                        .map(td => td.textContent.toLowerCase())
                        .join(" ")
                        .includes(query);
        });
    }

    // Render table for current page
    function renderTable() {
        const filteredRows = getFilteredRows();
        const totalPages = Math.ceil(filteredRows.length / rowsPerPage) || 1;

        getAllRows().forEach(r => r.style.display = "none");

        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        filteredRows.slice(start, end).forEach(r => r.style.display = "");

        renderPagination(totalPages);
    }

    // Render pagination buttons
    function renderPagination(totalPages) {
        pagination.innerHTML = "";

        if(totalPages <= 1) return;

        // Previous
        const prev = document.createElement("li");
        prev.className = "page-item" + (currentPage===1?" disabled":"");
        prev.innerHTML = `<a class="page-link" href="#">Previous</a>`;
        prev.addEventListener("click", e=>{
            e.preventDefault();
            if(currentPage>1){ currentPage--; renderTable(); }
        });
        pagination.appendChild(prev);

        // Page numbers
        for(let i=1;i<=totalPages;i++){
            const li = document.createElement("li");
            li.className = "page-item" + (i===currentPage?" active":"");
            li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
            li.addEventListener("click", e=>{
                e.preventDefault();
                currentPage=i;
                renderTable();
            });
            pagination.appendChild(li);
        }

        // Next
        const next = document.createElement("li");
        next.className = "page-item" + (currentPage===totalPages?" disabled":"");
        next.innerHTML = `<a class="page-link" href="#">Next</a>`;
        next.addEventListener("click", e=>{
            e.preventDefault();
            if(currentPage<totalPages){ currentPage++; renderTable(); }
        });
        pagination.appendChild(next);
    }

    // Search input
    searchInput.addEventListener("input", function(){
        currentPage=1;
        renderTable();
    });

    // Initial render
    renderTable();

});
</script>
{% endblock %}
